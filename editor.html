<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Редактор — ResumeHelper</title>

  <link rel="stylesheet" href="css/style.css">
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">

  <style>
    .editor-card{
      border:1px solid #e6e6e6;
      padding:18px;
      border-radius:12px;
      background:#fff;
      box-shadow:0 6px 18px rgba(3,6,7,0.05);
      margin-top:26px;
    }
    #editor{height:540px;border-radius:8px;background:white}
    .editor-controls{
      display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;
      align-items:center;
    }
    select,input,button{
      font-family:Inter;
    }
    .small{
      padding:8px 10px;border-radius:8px;border:1px solid #ddd;
    }
    .small-input{
      padding:8px;border-radius:8px;border:1px solid #ddd;
      min-width:220px;
    }
    .action-btn{
      padding:8px 10px;border-radius:8px;border:none;
      background:var(--btn-bg);color:white;font-weight:600;cursor:pointer;
    }
    .danger{background:#c0392b;color:white;border:none}
    .template-grid{
      display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
      gap:16px;margin-top:12px;
    }
    .template-card{
      border:1px solid #eee;border-radius:12px;padding:14px;
      background:white;box-shadow:0 6px 14px rgba(3,6,7,0.05);
      display:flex;flex-direction:column;gap:10px;
    }
    .tpl-preview{color:#444;font-size:14px;line-height:1.4}
    .template-actions{display:flex;gap:8px}
    .muted{color:#777;font-size:13px}
    .saved-list{
      max-height:200px;overflow:auto;padding:8px;
      border-radius:8px;border:1px solid #eee;background:#fafafa;
    }
    @media(max-width:820px){
      .editor-controls{flex-direction:column;align-items:stretch}
    }
  </style>
</head>
<body>

<header class="header">
  <div class="brand">ResumeHelper</div>

  <div style="display:flex;align-items:center;gap:18px">
    <nav class="main-nav">
      <a href="index.html">Главная</a>
      <a href="services.html">Услуги</a>
      <a href="tools.html">Инструменты</a>
      <a href="materials.html">Материалы</a>
      <a href="account.html">Кабинет</a>
      <a href="reviews.html">Отзывы</a>
    </nav>

    <div class="auth-buttons">
      <!-- кнопки авторизации рендерятся из js/auth.js -->
    </div>
  </div>
</header>

<main class="container">
  <h1 class="page-title">Редактор документов</h1>

  <!-- вывод количества -->
  <p class="lead" id="countsBox"></p>

  <div class="editor-card">

    <!-- панель управления -->
    <div class="editor-controls">

      <select id="templatesSelect" class="small">
        <option value="">— Быстрые шаблоны —</option>
      </select>

      <button id="loadTemplate" class="action-btn small">Загрузить</button>
      <button id="insertTemplate" class="small">Вставить</button>

      <input id="docTitle" class="small-input" placeholder="Название документа">

      <button id="saveLocal" class="action-btn small">Сохранить</button>
      <button id="saveAsTemplate" class="small">Добавить в шаблоны</button>
      <button id="exportDocx" class="small">DOCX</button>
      <button id="exportPdf" class="small">PDF</button>
      <button id="clearEditor" class="danger small">Очистить</button>

    </div>

    <!-- панель Quill -->
    <div id="toolbar" style="margin-bottom:10px">
      <span class="ql-formats">
        <select class="ql-header">
          <option selected></option>
          <option value="1"></option>
          <option value="2"></option>
        </select>
        <button class="ql-bold"></button>
        <button class="ql-italic"></button>
        <button class="ql-underline"></button>
      </span>
      <span class="ql-formats">
        <button class="ql-list" value="ordered"></button>
        <button class="ql-list" value="bullet"></button>
        <button class="ql-align" value="center"></button>
        <button class="ql-align" value="right"></button>
      </span>
    </div>

    <div id="editor"></div>

    <!-- шаблоны + документы -->
    <section style="margin-top:22px">
      <div style="display:flex;gap:20px;flex-wrap:wrap">

        <div style="flex:1;min-width:320px">
          <h3>Шаблоны</h3>
          <div class="template-grid" id="templateGrid"></div>
        </div>

        <div style="width:320px">
          <h3>Сохранённые документы</h3>
          <div class="saved-list" id="savedList"></div>
        </div>

      </div>
    </section>

  </div>
</main>

<footer class="footer container">
  © 2025 ResumeHelper — сделано с ❤️
</footer>

<!-- библиотеки -->
<script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
<script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- ваши глобальные проекты/скрипты -->
<script src="js/firebase-config.js"></script> <!-- содержит db, auth --> 
<script src="js/auth.js"></script>          <!-- рендер кнопок и auth listener --> 
<script src="js/templates-data.js"></script> <!-- READY_TEMPLATES встроенные --> 

<!-- логика: сохраняет в Firestore, использует templates -->
<script>
/* === editor-firestore inline (встроенный, чтобы ничего не забыть при вставке) ===
   Этот скрипт — эквивалент js/editor-firestore.js: сохраняет документы в Firestore,
   загружает user шаблоны и документы, обрабатывает кнопки загрузки/вставки шаблонов.
   Я оставил его inline, чтобы при замене файла было проще — ты можешь вынести в js/editor-firestore.js.
*/

(function(){
  // Инициализация Quill (как в оригинале)
  const quill = new Quill("#editor", { theme: "snow", modules: { toolbar: "#toolbar" } });

  // Firestore коллекции
  const docsCol = db.collection("documents");
  const templatesCol = db.collection("templates");

  // DOM refs
  const titleInput = document.getElementById("docTitle");
  const savedList = document.getElementById("savedList");
  const templateGrid = document.getElementById("templateGrid");
  const templatesSelect = document.getElementById("templatesSelect");

  // --- Load built ready templates into select & grid (always) ---
  function renderBuiltTemplates(){
    // templatesSelect
    templatesSelect.innerHTML = '<option value="">— Быстрые шаблоны —</option>';
    (window.READY_TEMPLATES || []).forEach(t=>{
      const opt = document.createElement('option'); opt.value = t.key; opt.textContent = t.title;
      templatesSelect.appendChild(opt);
    });

    // grid
    templateGrid.innerHTML = "";
    (window.READY_TEMPLATES || []).forEach(t=>{
      const div = document.createElement("div");
      div.className = "template-card";
      div.innerHTML = `
        <div><strong>${t.title}</strong></div>
        <div class="tpl-preview">${t.html.replace(/<[^>]+>/g,"").slice(0,160)}...</div>
        <div class="template-actions">
          <button class="small" data-key="${t.key}">Вставить</button>
          <button class="small action-btn" data-open="${t.key}">Открыть</button>
        </div>`;
      templateGrid.appendChild(div);
    });
  }

  // --- Load user templates from Firestore (if logged) ---
  async function loadUserTemplates(){
    // append user templates into select & grid
    const user = window.CURRENT_USER;
    if(!user) return;

    try{
      const snap = await templatesCol.where("uid","==",user.uid).orderBy("createdAt","desc").get();
      snap.forEach(doc=>{
        const t = doc.data();
        const key = "user_" + doc.id;
        // select
        const opt = document.createElement('option'); opt.value = key; opt.textContent = t.title;
        templatesSelect.appendChild(opt);
        // grid
        const div = document.createElement("div");
        div.className = "template-card";
        div.innerHTML = `
          <div><strong>${t.title}</strong></div>
          <div class="tpl-preview">${(t.html||"").replace(/<[^>]+>/g,"").slice(0,160)}...</div>
          <div class="template-actions">
            <button class="small" data-key="${key}">Вставить</button>
            <button class="small action-btn" data-open="${key}">Открыть</button>
          </div>`;
        templateGrid.appendChild(div);
      });
    }catch(e){ console.error("loadUserTemplates", e); }
  }

  // --- Helper to get template HTML by key ---
  async function getTemplateHTML(key){
    if(!key) return null;
    // built:
    const built = (window.READY_TEMPLATES||[]).find(t=>t.key===key);
    if(built) return built.html;
    // user:
    if(key.startsWith("user_")){
      const id = key.replace("user_","");
      const snap = await templatesCol.doc(id).get();
      if(snap.exists) return snap.data().html;
    }
    return null;
  }

  // --- Insert template at cursor ---
  window.insertTemplateFS = async function(key){
    const html = await getTemplateHTML(key);
    if(!html) return alert("Шаблон не найден");
    const range = quill.getSelection(true) || {index: quill.getLength()};
    quill.clipboard.dangerouslyPasteHTML(range.index, html);
  };

  // --- Load template replacing editor content ---
  window.loadTemplateFS = async function(key){
    const html = await getTemplateHTML(key);
    if(!html) return alert("Шаблон не найден");
    quill.setContents([]); quill.clipboard.dangerouslyPasteHTML(html);
  };

  // --- Save document to Firestore (button saveLocal) ---
  document.getElementById("saveLocal").addEventListener("click", async ()=>{
    const user = window.CURRENT_USER;
    if(!user) return alert("Войдите в аккаунт чтобы сохранять документы");
    const html = quill.root.innerHTML;
    const title = titleInput.value || "Без названия";
    try{
      await docsCol.add({ uid: user.uid, title, html, createdAt: Date.now() });
      alert("Документ сохранён в облако");
      loadUserDocs();
    }catch(e){ console.error("save doc", e); alert("Ошибка при сохранении: " + e.message); }
  });

  // --- Load user's documents from Firestore ---
  async function loadUserDocs(){
    const user = window.CURRENT_USER;
    if(!user){
      savedList.innerHTML = "<div class='muted'>Войдите чтобы видеть документы</div>";
      return;
    }
    try{
      const snap = await docsCol.where("uid","==",user.uid).orderBy("createdAt","desc").get();
      if(snap.empty){
        savedList.innerHTML = "<div class='muted'>Нет документов</div>";
        return;
      }
      savedList.innerHTML = "";
      snap.forEach(doc=>{
        const d = doc.data();
        const row = document.createElement("div");
        row.style.cssText = "margin-bottom:10px;display:flex;justify-content:space-between";
        row.innerHTML = `
          <div style="font-size:14px">
            <strong>${d.title}</strong><br>
            <span class="muted">${new Date(d.createdAt).toLocaleString()}</span>
          </div>
          <div>
            <button class="small" data-opendoc="${doc.id}">Открыть</button>
            <button class="small danger" data-del="${doc.id}">Удалить</button>
          </div>`;
        savedList.appendChild(row);
      });
    }catch(e){ console.error("loadUserDocs", e); savedList.innerHTML = "<div class='muted'>Ошибка загрузки</div>"; }
  }

  window.openDocFS = async function(id){
    try{
      const snap = await docsCol.doc(id).get();
      if(!snap.exists) return alert("Документ не найден");
      const d = snap.data();
      titleInput.value = d.title;
      quill.root.innerHTML = d.html;
    }catch(e){ console.error(e); alert("Ошибка открытия: " + e.message); }
  };

  window.deleteDocFS = async function(id){
    if(!confirm("Удалить документ?")) return;
    try{
      await docsCol.doc(id).delete();
      loadUserDocs();
    }catch(e){ console.error(e); alert("Ошибка удаления: " + e.message); }
  };

  // --- Save current editor content as user template ---
  document.getElementById("saveAsTemplate").addEventListener("click", async ()=>{
    const user = window.CURRENT_USER;
    if(!user) return alert("Войдите чтобы сохранять шаблоны");
    const html = quill.root.innerHTML;
    const title = prompt("Название шаблона:") || "Новый шаблон";
    try{
      await templatesCol.add({ uid: user.uid, title, html, createdAt: Date.now() });
      alert("Шаблон сохранён");
      // reload user templates
      templateGrid.innerHTML = ""; renderBuiltTemplates(); await loadUserTemplates();
    }catch(e){ console.error(e); alert("Ошибка: " + e.message); }
  });

  // --- Export DOCX ---
  document.getElementById("exportDocx").addEventListener("click", ()=>{
    const safeName = (titleInput.value || "document").replace(/[\\/:*?"<>|]/g, "_") + ".docx";
    const html = `<!DOCTYPE html><html><head><meta charset="utf-8"></head><body>${quill.root.innerHTML}</body></html>`;
    const blob = htmlDocx.asBlob(html);
    saveAs(blob, safeName);
  });

  // --- Export PDF ---
  document.getElementById("exportPdf").addEventListener("click", ()=>{
    const container = document.createElement("div");
    container.style.padding = "20px";
    container.style.background = "white";
    container.innerHTML = quill.root.innerHTML;
    document.body.appendChild(container);
    const opt = { margin:20, filename:(titleInput.value||"document")+".pdf", html2canvas:{scale:2}, jsPDF:{unit:"pt", format:"a4"} };
    html2pdf().set(opt).from(container).save().then(()=>document.body.removeChild(container));
  });

  // --- Clear editor ---
  document.getElementById("clearEditor").addEventListener("click", ()=>{
    if(confirm("Очистить?")) quill.setContents([]);
  });

  // --- Buttons in template cards (delegation) & saved docs list delegation ---
  // templateGrid delegation
  templateGrid.addEventListener("click", (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    const key = btn.getAttribute("data-key");
    const open = btn.getAttribute("data-open");
    if(key) insertTemplateFS(key);
    if(open) loadTemplateFS(open);
  });

  // savedList delegation
  savedList.addEventListener("click", (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    const openId = btn.getAttribute("data-opendoc");
    const delId = btn.getAttribute("data-del");
    if(openId) openDocFS(openId);
    if(delId) deleteDocFS(delId);
  });

  // --- Top select buttons handlers ---
  document.getElementById("loadTemplate").addEventListener("click", ()=>{
    const key = templatesSelect.value;
    if(!key) return alert("Выберите шаблон");
    loadTemplateFS(key);
  });

  document.getElementById("insertTemplate").addEventListener("click", ()=>{
    const key = templatesSelect.value;
    if(!key) return alert("Выберите шаблон");
    insertTemplateFS(key);
  });

  // --- Load from ?template= or ?doc= on page load ---
  async function loadFromQuery(){
    const params = new URLSearchParams(location.search);
    const tpl = params.get("template");
    const docId = params.get("doc");
    if(tpl){
      // try built first else user_
      if(tpl.startsWith("tpl_") || (window.READY_TEMPLATES||[]).find(t=>t.key===tpl)){
        const built = (window.READY_TEMPLATES||[]).find(t=>t.key===tpl);
        if(built){ titleInput.value = built.title; quill.clipboard.dangerouslyPasteHTML(built.html); return; }
      }
      // else user template id maybe
      if(tpl.startsWith("user_")){
        const id = tpl.replace("user_","");
        const snap = await templatesCol.doc(id).get();
        if(snap.exists){ const t = snap.data(); titleInput.value = t.title; quill.clipboard.dangerouslyPasteHTML(t.html); return; }
      }
    }
    if(docId){
      // open doc by id
      try{
        const snap = await docsCol.doc(docId).get();
        if(snap.exists){ const d = snap.data(); titleInput.value = d.title; quill.root.innerHTML = d.html; }
      }catch(e){ console.warn(e); }
    }
  }

  // --- When auth state changes: load user templates/docs ---
  document.addEventListener("auth-changed", ()=>{
    renderBuiltTemplates();
    loadUserTemplates();
    loadUserDocs();
    loadFromQuery();
  });

  // initial render for guests
  renderBuiltTemplates();
  // if already signed in
  if(window.CURRENT_USER){
    loadUserTemplates(); loadUserDocs(); loadFromQuery();
  }

})(); // end IIFE
</script>

</body>
</html>
