<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Мои документы — ResumeHelper</title>
<link rel="stylesheet" href="css/style.css">
</head>
<body>

<header class="header">
  <div class="brand">ResumeHelper</div>
  <div style="display:flex;align-items:center;gap:18px;flex-wrap:wrap">
    <nav class="main-nav">
      <a href="index.html">Главная</a>
      <a href="services.html">Услуги</a>
      <a href="tools.html">Инструменты</a>
      <a href="materials.html">Материалы</a>
      <a href="account.html">Кабинет</a>
      <a href="reviews.html">Отзывы</a>
    </nav>
    <div class="auth-buttons"></div>
  </div>
</header>

<main class="container">
  <h1 class="page-title">Мои документы</h1>
  <p class="lead">Все документы сохраняются за вашим аккаунтом</p>

  <!-- КНОПКА СОЗДАНИЯ -->
  <button class="btn-primary" onclick="createNewDoc()" style="margin-top:10px">
    Создать документ
  </button>

  <!-- СПИСОК -->
  <div id="docs" class="doc-list"></div>
</main>

<footer class="footer container">© 2025 ResumeHelper</footer>

<script>
  let CURRENT_USER = null;

  // === 1. Ждем авторизацию ===
  document.addEventListener("auth-changed", async e => {
    CURRENT_USER = e.detail.user;
    if (!CURRENT_USER) return;

    loadDocs();
  });

  // === 2. Загрузка документов из Firestore ===
  async function loadDocs() {
    const box = document.getElementById("docs");
    box.innerHTML = "<p>Загрузка...</p>";

    try {
      const snap = await db.collection("users")
        .doc(CURRENT_USER.uid)
        .collection("documents")
        .orderBy("updated", "desc")
        .get();

      if (snap.empty) {
        box.innerHTML = "<p class='empty'>Документов пока нет</p>";
        return;
      }

      box.innerHTML = "";

      snap.forEach(doc => {
        const data = doc.data();

        const card = document.createElement("div");
        card.className = "doc-card";

        card.innerHTML = `
          <div>
            <strong>${data.title}</strong><br>
            <span>${new Date(data.updated).toLocaleString()}</span>
          </div>
          <div>
            <button class="doc-btn-open" onclick="openDoc('${doc.id}')">
              Открыть
            </button>
            <button class="doc-btn-delete" onclick="deleteDoc('${doc.id}')">
              Удалить
            </button>
          </div>
        `;

        box.appendChild(card);
      });

    } catch(e) {
      box.innerHTML = "<p class='empty'>Ошибка загрузки</p>";
      console.error(e);
    }
  }

  // === 3. Открыть документ ===
  function openDoc(id) {
    location.href = "editor.html?id=" + id;
  }

  // === 4. Удалить документ ===
  async function deleteDoc(id) {
    if (!confirm("Удалить документ?")) return;

    await db.collection("users")
      .doc(CURRENT_USER.uid)
      .collection("documents")
      .doc(id)
      .delete();

    loadDocs();
  }

  // === 5. Создать документ ===
  function createNewDoc() {
    const id = "doc_" + Date.now();
    location.href = "editor.html?id=" + id;
  }
</script>

</body>
</html>

