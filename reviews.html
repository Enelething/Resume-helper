<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Отзывы — ResumeHelper</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .panel{background:#fff;padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(3,6,7,0.06)}
    textarea{width:100%;min-height:100px;padding:10px;border-radius:10px;border:1px solid #e6e6e6;font-size:14px}
    select{padding:6px 8px;border-radius:8px;border:1px solid #ddd}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;background:#f2f2f2;color:#666;margin-left:6px;}
    .delete-btn{background:#c0392b;color:#fff;border:none;padding:6px 8px;border-radius:8px;cursor:pointer;font-size:12px;}
  </style>
</head>
<body>

<header class="header">
  <div class="brand">ResumeHelper</div>
  <div style="display:flex;align-items:center;gap:18px;flex-wrap:wrap">
    <nav class="main-nav">
      <a href="index.html">Главная</a>
      <a href="services.html">Услуги</a>
      <a href="tools.html">Инструменты</a>
      <a href="materials.html">Материалы</a>
      <a href="account.html">Кабинет</a>
      <a href="reviews.html" class="active">Отзывы</a>
    </nav>
    <div class="auth-buttons"></div>
  </div>
</header>

<main class="container">
  <h1 class="page-title">Отзывы и кейсы</h1>
  <p class="lead">Истории успеха наших пользователей и их впечатления о сервисе.</p>

  <section class="panel" id="addReviewBox" style="margin-top:18px;display:none;">
    <h2 class="page-title-medium">Оставить отзыв</h2>
    <p class="muted" style="margin:4px 0 10px;">Отзыв будет опубликован под вашим именем и почтой из профиля.</p>
    <label>Оценка:
      <select id="reviewStars">
        <option value="5">★★★★★</option>
        <option value="4">★★★★☆</option>
        <option value="3">★★★☆☆</option>
        <option value="2">★★☆☆☆</option>
        <option value="1">★☆☆☆☆</option>
      </select>
    </label>
    <textarea id="reviewText" placeholder="Напишите, что вам понравилось, что помогло, или что можно улучшить..."></textarea>
    <button class="btn-primary" style="margin-top:8px;" onclick="submitReview()">Отправить отзыв</button>
  </section>

  <section class="reviews-section" style="margin-top:24px;">
    <h2 class="page-title-medium">Отзывы</h2>
    <div id="reviewsList" class="review-list" style="margin-top:10px;"></div>
    <p id="noReviews" style="color:#666;display:none;">Пока отзывов нет — станьте первым!</p>
  </section>
</main>

<footer class="footer container">© 2025 ResumeHelper</footer>

<!-- Firebase + Auth -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="js/firebase-config.js"></script>
<script src="js/auth.js"></script>

<script>
<script>
/* Использует глобальные auth, db, CURRENT_USER, ADMINS из js/firebase-config.js и js/auth.js */
function isAdmin(user){
  if(!user) return false;
  return (window.ADMINS || []).includes(user.email);
}

const reviewsCol = db.collection('reviews');

/* Рендер одного отзыва */
function renderReviewItem(doc, userIsAdmin){
  const r = doc.data();
  const id = doc.id;
  const div = document.createElement("div");
  div.className = "review-card";
  const stars = "★★★★★".slice(0, r.stars || 5);
  const date = r.createdAt ? new Date(r.createdAt).toLocaleString() : "";

  div.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;">
      <div>
        <div class="reviewer-name">${escapeHtml(r.userName || "Аноним")}
          <span class="pill">${stars}</span>
        </div>
        <div class="muted" style="font-size:12px;">${escapeHtml(r.userEmail || "")} • ${date}</div>
      </div>
      ${userIsAdmin ? `<button class="delete-btn" data-id="${id}">Удалить</button>` : ""}
    </div>
    <div class="review-text" style="margin-top:6px;">${escapeHtml(r.text || "")}</div>
  `;
  return div;
}

/* Безопасный escape (простая реализация) */
function escapeHtml(s){
  if(!s) return "";
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}

function attachDeleteHandlers(container){
  container.querySelectorAll(".delete-btn").forEach(btn=>{
    btn.addEventListener("click", async (e)=>{
      const id = e.currentTarget.getAttribute("data-id");
      if(!confirm("Удалить отзыв?")) return;
      try{
        await reviewsCol.doc(id).delete();
        // onSnapshot обновит UI
      }catch(err){
        console.error(err);
        alert("Не удалось удалить отзыв: " + err.message);
      }
    });
  });
}

/* РИСОВКА списка — используется onSnapshot для реального времени */
let reviewsUnsub = null;
function subscribeReviews(){
  const list = document.getElementById("reviewsList");
  const empty = document.getElementById("noReviews");

  if(reviewsUnsub) reviewsUnsub();

  reviewsUnsub = reviewsCol.orderBy('createdAt','desc').onSnapshot(snapshot=>{
    list.innerHTML = "";
    if(snapshot.empty){
      empty.style.display = "";
      return;
    }
    empty.style.display = "none";

    const user = window.CURRENT_USER;
    const userIsAdmin = isAdmin(user);

    snapshot.forEach(doc=>{
      const node = renderReviewItem(doc, userIsAdmin);
      list.appendChild(node);
    });

    // повесим обработчики удаления (если есть кнопки)
    attachDeleteHandlers(list);
  }, err=>{
    console.error("reviews onSnapshot error", err);
    document.getElementById("noReviews").textContent = "Ошибка загрузки отзывов.";
    document.getElementById("noReviews").style.display = "";
  });
}

/* Отправка нового отзыва в Firestore */
async function submitReview(){
  const user = window.CURRENT_USER;
  if(!user) return alert("Только авторизованные пользователи могут оставлять отзывы.");

  const textEl = document.getElementById("reviewText");
  const stars = parseInt(document.getElementById("reviewStars").value,10);
  const text = textEl.value.trim();
  if(!text) return alert("Напишите текст отзыва.");

  const payload = {
    uid: user.uid,
    userName: user.displayName || "Пользователь",
    userEmail: user.email || "",
    text,
    stars,
    createdAt: Date.now()
  };

  try{
    await reviewsCol.add(payload);
    textEl.value = "";
    // onSnapshot обновит UI
  }catch(e){
    console.error(e);
    alert("Ошибка при отправке: " + e.message);
  }
}

/* UI реакция на смену аутентификации */
document.addEventListener("auth-changed", e=>{
  const user = e.detail.user;
  const box = document.getElementById("addReviewBox");
  box.style.display = user ? "" : "none";

  // Подпишемся на отзывы (показываем один и тот же список для всех авторизованных)
  subscribeReviews();
});

/* Инициализация при загрузке страницы: если уже залогинен, подписываемся */
document.addEventListener("DOMContentLoaded", ()=>{
  // прячем форму если не залогинен (auth.js выставит на auth-changed)
  const user = window.CURRENT_USER;
  document.getElementById("addReviewBox").style.display = user ? "" : "none";
  subscribeReviews();
});
</script>

</script>

</body>
</html>
