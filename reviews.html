<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Отзывы — ResumeHelper</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .panel{background:#fff;padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(3,6,7,0.06)}
    textarea{width:100%;min-height:100px;padding:10px;border-radius:10px;border:1px solid #e6e6e6;font-size:14px}
    select{padding:6px 8px;border-radius:8px;border:1px solid #ddd}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;background:#f2f2f2;color:#666;margin-left:6px;}
    .delete-btn{background:#c0392b;color:#fff;border:none;padding:6px 8px;border-radius:8px;cursor:pointer;font-size:12px;}
  </style>
</head>
<body>

<header class="header">
  <div class="brand">ResumeHelper</div>
  <div style="display:flex;align-items:center;gap:18px;flex-wrap:wrap">
    <nav class="main-nav">
      <a href="index.html">Главная</a>
      <a href="services.html">Услуги</a>
      <a href="tools.html">Инструменты</a>
      <a href="materials.html">Материалы</a>
      <a href="account.html">Кабинет</a>
      <a href="reviews.html" class="active">Отзывы</a>
    </nav>
    <div class="auth-buttons"></div>
  </div>
</header>

<main class="container">
  <h1 class="page-title">Отзывы и кейсы</h1>
  <p class="lead">Истории успеха наших пользователей и их впечатления о сервисе.</p>

  <section class="panel" id="addReviewBox" style="margin-top:18px;display:none;">
    <h2 class="page-title-medium">Оставить отзыв</h2>
    <p class="muted" style="margin:4px 0 10px;">Отзыв будет опубликован под вашим именем и почтой из профиля.</p>
    <label>Оценка:
      <select id="reviewStars">
        <option value="5">★★★★★</option>
        <option value="4">★★★★☆</option>
        <option value="3">★★★☆☆</option>
        <option value="2">★★☆☆☆</option>
        <option value="1">★☆☆☆☆</option>
      </select>
    </label>
    <textarea id="reviewText" placeholder="Напишите, что вам понравилось, что помогло, или что можно улучшить..."></textarea>
    <button class="btn-primary" style="margin-top:8px;" onclick="submitReview()">Отправить отзыв</button>
  </section>

  <section class="reviews-section" style="margin-top:24px;">
    <h2 class="page-title-medium">Отзывы</h2>
    <div id="reviewsList" class="review-list" style="margin-top:10px;"></div>
    <p id="noReviews" style="color:#666;display:none;">Пока отзывов нет — станьте первым!</p>
  </section>
</main>

<footer class="footer container">© 2025 ResumeHelper</footer>

<!-- Firebase + Auth -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="js/firebase-config.js"></script>
<script src="js/auth.js"></script>

<script>
function isAdmin(user){
  if(!user) return false;
  return (window.ADMINS || []).includes(user.email);
}

function getAllReviews(){
  return Object.keys(localStorage)
    .filter(k=>k.startsWith("review_"))
    .map(k=>{
      try{
        const v = JSON.parse(localStorage.getItem(k));
        v._key = k;
        return v;
      }catch(e){ return null;}
    })
    .filter(Boolean)
    .sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
}

function renderReviews(){
  const list = document.getElementById("reviewsList");
  const empty = document.getElementById("noReviews");
  list.innerHTML = "";

  const items = getAllReviews();
  if(!items.length){
    empty.style.display = "";
    return;
  }
  empty.style.display = "none";

  const user = window.CURRENT_USER;
  const admin = isAdmin(user);

  items.forEach(r=>{
    const div = document.createElement("div");
    div.className = "review-card";
    const stars = "★★★★★".slice(0, r.stars || 5);

    const date = r.createdAt ? new Date(r.createdAt).toLocaleString() : "";

    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;">
        <div>
          <div class="reviewer-name">${r.userName || "Аноним"}
            <span class="pill">${stars}</span>
          </div>
          <div class="muted" style="font-size:12px;">${r.userEmail || ""} • ${date}</div>
        </div>
        ${admin ? `<button class="delete-btn" onclick="deleteReview('${r._key}')">Удалить</button>` : ""}
      </div>
      <div class="review-text" style="margin-top:6px;">${r.text || ""}</div>
    `;
    list.appendChild(div);
  });
}

function submitReview(){
  const user = window.CURRENT_USER;
  if(!user){
    return alert("Только авторизованные пользователи могут оставлять отзывы.");
  }
  const text = document.getElementById("reviewText").value.trim();
  const stars = parseInt(document.getElementById("reviewStars").value, 10);
  if(!text) return alert("Напишите текст отзыва.");

  const id = Date.now();
  const key = "review_" + id;
  const item = {
    id,
    uid: user.uid,
    userName: user.displayName || "Пользователь",
    userEmail: user.email || "",
    text,
    stars,
    createdAt: id
  };
  localStorage.setItem(key, JSON.stringify(item));
  document.getElementById("reviewText").value = "";
  renderReviews();
}

function deleteReview(key){
  if(!confirm("Удалить отзыв?")) return;
  localStorage.removeItem(key);
  renderReviews();
}

document.addEventListener("auth-changed", e=>{
  const user = e.detail.user;
  const box = document.getElementById("addReviewBox");
  box.style.display = user ? "" : "none";
  renderReviews();
});

document.addEventListener("DOMContentLoaded", renderReviews);
</script>

</body>
</html>
